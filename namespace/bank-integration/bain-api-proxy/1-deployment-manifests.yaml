apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: bain-api-proxy
  namespace: bank-integration
  labels:
    app.kubernetes.io/name: bain-api-proxy
    app: bain-api-proxy
spec:
  strategy:
    canary:
      maxUnavailable: 1
      steps:
        - setWeight: 50
        - pause: { duration: 3m }
        - setWeight: 100
        - pause: { duration: 30m }
  selector:
    matchLabels:
      app.kubernetes.io/name: bain-api-proxy
  template:
    metadata:
      labels:
        app.kubernetes.io/name: bain-api-proxy
        app: bain-api-proxy
    spec:
      securityContext:
        runAsUser: 1000
        runAsGroup: 2000
      terminationGracePeriodSeconds: 120
      containers:
        - name: bain-api-proxy
          imagePullPolicy: IfNotPresent
          image: nginx-preview-proxy:local
          ports:
            - containerPort: 8080
              name: http
          env:
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 9101
              scheme: HTTP
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 6
          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: 9101
              scheme: HTTP
            periodSeconds: 10
            timeoutSeconds: 10
          startupProbe:
            httpGet:
              path: /actuator/health/readiness
              port: 9101
              scheme: HTTP
            failureThreshold: 60
            periodSeconds: 15
            timeoutSeconds: 5
